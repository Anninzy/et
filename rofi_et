#!/bin/sh

# TODO: Remember to make the wordlist path, the DELIMITER,
# TODO: the colors configurable, and the max number of definitions

exit_on_esc () {
  EXIT_CODE=$?
  if [ $EXIT_CODE -ne 0 ]; then
    sed -Ei '/#message \{/,/\}/ s/(\s*)\/\* (border.*) \*\//\1\2/' $HOME/.config/rofi/config.rasi
    exit $EXIT_CODE
  fi
}

run_again () {
  if [ "$2" ]; then
    sed -Ei '/#message \{/,/\}/ s/(\s*)\/\* (border.*) \*\//\1\2/' $HOME/.config/rofi/config.rasi
    WORD=$(echo "$2" | rofi -dmenu -p $COMMAND -i -mesg "$1")
    exit_on_esc

    WORD_LENGTH=$(($(echo -n "$WORD" | wc -m) - 1))
    if [ $WORD_LENGTH -gt 0 ]; then
      NEW_WORD=$(echo -n "$WORD" | cut -c 1-$WORD_LENGTH)
      echo "$2" | grep -w "$NEW_WORD" > /dev/null
      IN_SUGGESTIONS=$?
      if [ $IN_SUGGESTIONS -eq 0 ]; then
        echo -n "$NEW_WORD" | xclip -r -selection clipboard

        which notify-send > /dev/null
        HAS_NOTIFY_SEND=$?
        if [ $HAS_NOTIFY_SEND -eq 0 ]; then
          notify-send -a 'rofi_et' "\"$NEW_WORD\" has been copied to clipboard"
        fi

        exit 0
      fi
    fi
  else
    if [ "$1" ]; then
      sed -Ei '/#message \{/,/\}/ s/^(\s*)(border.*);{0,1}$/\1\/* \2 *\//' $HOME/.config/rofi/config.rasi

      WORD=$(rofi -dmenu -p $COMMAND -i -mesg "$1" -lines 0)
      exit_on_esc
    else
      WORD=$(rofi -dmenu -p $COMMAND -i)
      exit_on_esc
    fi
  fi

  $0 "$WORD"
  exit 0
}

spell () {
  agrep -iB "$1" $HOME/.local/share/rofi/rofi_et_wordlist.txt | grep -iw "$1" > /dev/null
  FOUND=$?
  PROCEED_TO_DEFINE=$2
  if [ $FOUND -eq 0 ]; then
    if [ $PROCEED_TO_DEFINE -ne 0 ]; then
      run_again "<span foreground='green'>\"$1\" appears to be spelled correctly</span>"
    fi
  else
    MESG=$(
cat << EOF
<span foreground='red'>"$1" doesn't appear to be spelled correctly.</span>
Suggestions:
EOF
    )

    SUGGESTIONS=$(agrep -iB "$1" $HOME/.local/share/rofi/rofi_et_wordlist.txt | awk '{print length, $0}' | sort -n | cut -d " " -f2-)

    run_again "$MESG" "$SUGGESTIONS"
  fi
}

get_definitions () {
  D=";;;"

  WORDNIK_URL="https://www.wordnik.com/words/$1"
  DEFINITIONS=$(
  echo -n "$(curl -s $WORDNIK_URL)" |\
  sed "/guts active/,/<\/ul>/!d;\
  /<li>/!d" |\
  sed -E "s/\s*<li><abbr title=\"partOfSpeech\">(.+)<\/abbr> <i>(.*)<\/i> (.*)<\/li>/<${D}b${D}><${D}i${D}>\1<${D}\/i${D}><${D}\/b${D}> [<${D}small${D}>\2<${D}\/small${D}>] \3/;\
  s/ \[<${D}small${D}><${D}\/small${D}>\]//g;\
  s/\s{2,}/ /g;\
  s/<[^\;][^>]*>//g;\
  s/$D//g;\
  s/&/\&amp\;/g" |\
  head -n 13
  )

  echo "$DEFINITIONS"
}

define () {
  COMMAND="spell"
  spell $1 0
  COMMAND="define"

  DEFINITIONS=$(
cat << EOF
<b><i><u>Definitions from Wordnik</u></i></b>:
$(get_definitions $1)
EOF
  )

  run_again "$DEFINITIONS"
}

usage () {
  cat << EOF
<u>Usage (in rofi's input bar)</u>:
  COMMAND [WORD]

<u>Commands</u>:
  <b><i>help</i></b>
    display this help message

  <b><i>define</i></b>
    get definitions for WORD from wordnik if correctly spelled, otherwise display spell suggestions. (WORD is required for this command)

  <b><i>spell</i></b>
    get spell suggestions for WORD from wordlist if not spelled correctly, otherwise display a message indicating that WORD is spelled correctly. (WORD is required for this command)
EOF
}

COMMAND="query"

if [ "$@" ]; then
  COMMAND=$(echo "$@" | cut -d " " -f 1)
  WORD=$(echo "$@" | cut -d " " -f 2)

  if [ "$COMMAND" == "help" ]; then
    run_again "$(usage)"
  else
    SPACE_COUNT=$(echo "$@" | tr -cd ' \t' | wc -c)
    if [ "$WORD" == "" ] || [ $SPACE_COUNT -lt 1 ]; then
      COMMAND="query"
      run_again "<span foreground='red'>You need to specifiy a command and a word</span>"
    else
      if [ "$COMMAND" == "spell" ]; then
        spell $WORD 1
      elif [ "$COMMAND" == "define" ]; then
        define $WORD
      else
        UNKNOWN_COMMAND=$COMMAND
        COMMAND="query"
        run_again "<span foreground='red'>Unkown command \"$UNKNOWN_COMMAND\"</span>"
      fi
    fi
  fi
else
  run_again
fi
